<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOLD - Satƒ±≈ü Takip Sistemi</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Ana Men√º Butonu -->
    <a href="https://partner.trek-turkey.com/giris/index.html" class="back-to-menu">
        ‚Üê Ana Men√º
    </a>
    <style>
        .back-to-menu {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.95);
            color: #1e3a5f;
            padding: 10px 18px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 9999;
            transition: all 0.3s ease;
        }
        .back-to-menu:hover {
            background: #1e3a5f;
            color: white;
            transform: translateX(-3px);
        }
    </style>

    <div class="container">
        <header>
            <h1>üí∞ SOLD</h1>
            <p class="subtitle">Stok Deƒüi≈üimlerinden Satƒ±≈ü Takibi</p>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button type="button" class="tab-btn active" data-tab="sales">üìä Satƒ±≈ülar</button>
            <button type="button" class="tab-btn" data-tab="analytics">üìà Analitik</button>
        </div>

        <!-- SALES TAB -->
        <div class="tab-content active" id="tab-sales">

        <!-- Controls -->
        <div class="controls">
            <div class="date-controls">
                <div class="date-group">
                    <label>Ba≈ülangƒ±√ß:</label>
                    <input type="date" id="date1">
                </div>
                <div class="date-group">
                    <label>Biti≈ü:</label>
                    <input type="date" id="date2">
                </div>
                <button class="btn btn-primary" id="loadBtn">Y√ºkle</button>
                <button class="btn btn-secondary" id="snapshotBtn">üì∏ Yeni Snapshot Al</button>
            </div>
            <span class="last-update" id="lastUpdate"></span>
        </div>

        <!-- Snapshot Info -->
        <div class="snapshot-info" id="snapshotInfo" style="display: none;">
            <div class="period">
                <span id="periodText"></span>
            </div>
            <div class="snapshot-list" id="snapshotList"></div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card card-total">
                <div class="card-icon">üì¶</div>
                <div class="card-content">
                    <h3>Toplam Satƒ±≈ü</h3>
                    <p id="totalSales">0</p>
                </div>
            </div>
            <div class="card card-qty">
                <div class="card-icon">üî¢</div>
                <div class="card-content">
                    <h3>Satƒ±lan Adet</h3>
                    <p id="totalQty">0</p>
                </div>
            </div>
            <div class="card card-value">
                <div class="card-icon">üí∂</div>
                <div class="card-content">
                    <h3>Toplam Deƒüer</h3>
                    <p id="totalValue">‚Ç¨0</p>
                </div>
            </div>
            <div class="card card-bikes">
                <div class="card-icon">üö≤</div>
                <div class="card-content">
                    <h3>Bisiklet Satƒ±≈üƒ±</h3>
                    <p id="bikeCount">0</p>
                </div>
            </div>
        </div>

        <!-- Warehouse Summary -->
        <div class="warehouse-summary">
            <div class="warehouse-card caddebostan clickable" data-warehouse="CADDEBOSTAN">
                <h3>üìç CADDEBOSTAN <span class="badge">Ana Depo</span></h3>
                <div class="warehouse-stats">
                    <div class="stat">
                        <span class="stat-label">Satƒ±≈ü</span>
                        <span class="stat-value sold" id="cadde-sold">0</span>
                    </div>
                </div>
            </div>
            <div class="warehouse-card alsancak clickable" data-warehouse="ALSANCAK">
                <h3>üìç ALSANCAK</h3>
                <div class="warehouse-stats">
                    <div class="stat">
                        <span class="stat-label">Satƒ±≈ü</span>
                        <span class="stat-value sold" id="alsancak-sold">0</span>
                    </div>
                </div>
            </div>
            <div class="warehouse-card bahcekoy clickable" data-warehouse="BAHCEKOY">
                <h3>üìç BAH√áEK√ñY</h3>
                <div class="warehouse-stats">
                    <div class="stat">
                        <span class="stat-label">Satƒ±≈ü</span>
                        <span class="stat-value sold" id="bahcekoy-sold">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Table -->
        <section class="section">
            <h2>
                Satƒ±≈ü Detaylarƒ± <span id="salesCount" class="badge">0</span>
            </h2>

            <!-- Warehouse Filters -->
            <div class="filters">
                <span class="filter-label">Depo:</span>
                <button class="filter-btn active" data-warehouse="all">T√ºm√º</button>
                <button class="filter-btn" data-warehouse="CADDEBOSTAN">Caddebostan</button>
                <button class="filter-btn" data-warehouse="ALSANCAK">Alsancak</button>
                <button class="filter-btn" data-warehouse="BAHCEKOY">Bah√ßek√∂y</button>
            </div>

            <!-- Category Filters -->
            <div class="filters category-filters">
                <span class="filter-label">Kategori:</span>
                <button class="category-btn active" data-category="all">T√ºm√º</button>
                <div id="categoryButtons"></div>
            </div>

            <!-- Sort Filters -->
            <div class="filters sort-filters">
                <span class="filter-label">Sƒ±rala:</span>
                <button class="sort-btn active" data-sort="default">Varsayƒ±lan</button>
                <button class="sort-btn" data-sort="price-desc">Fiyat ‚Üì</button>
                <button class="sort-btn" data-sort="price-asc">Fiyat ‚Üë</button>
                <button class="sort-btn" data-sort="qty-desc">Adet ‚Üì</button>
                <button class="sort-btn" data-sort="total-desc">Toplam Deƒüer ‚Üì</button>
            </div>

            <div class="table-container">
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>√úr√ºn Kodu</th>
                            <th>√úr√ºn Adƒ±</th>
                            <th>Kategori</th>
                            <th>√áƒ±kan Depo</th>
                            <th>Giren Depo</th>
                            <th>Satƒ±≈ü</th>
                            <th>Stok Deƒüi≈üimi</th>
                            <th style="text-align: right;">Fiyat / Toplam</th>
                        </tr>
                    </thead>
                    <tbody id="salesBody">
                        <tr>
                            <td colspan="8" class="loading">
                                <div class="loading-spinner"></div>
                                Veriler y√ºkleniyor...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        </div><!-- END SALES TAB -->

        <!-- ANALYTICS TAB -->
        <div class="tab-content" id="tab-analytics">

            <!-- Analytics Period -->
            <div class="controls">
                <div class="date-controls">
                    <div class="date-group">
                        <label for="analyticsDays">Son:</label>
                        <select id="analyticsDays" title="Analiz periyodu">
                            <option value="7">7 g√ºn</option>
                            <option value="14">14 g√ºn</option>
                            <option value="30" selected>30 g√ºn</option>
                            <option value="90">90 g√ºn</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" id="loadAnalyticsBtn">Analiz Et</button>
                </div>
                <span class="last-update" id="analyticsLastUpdate"></span>
            </div>

            <!-- Analytics Summary Cards -->
            <div class="summary-cards">
                <div class="card card-total">
                    <div class="card-icon">üì¶</div>
                    <div class="card-content">
                        <h3>Toplam √úr√ºn</h3>
                        <p id="analyticsTotalProducts">0</p>
                    </div>
                </div>
                <div class="card card-qty">
                    <div class="card-icon">üìâ</div>
                    <div class="card-content">
                        <h3>Satƒ±lan</h3>
                        <p id="analyticsTotalSold">0</p>
                    </div>
                </div>
                <div class="card card-value">
                    <div class="card-icon">üìà</div>
                    <div class="card-content">
                        <h3>Giren</h3>
                        <p id="analyticsTotalArrived">0</p>
                    </div>
                </div>
                <div class="card card-bikes">
                    <div class="card-icon">üíÄ</div>
                    <div class="card-content">
                        <h3>√ñl√º Stok</h3>
                        <p id="analyticsDeadStock">0</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Sections -->
            <div class="analytics-grid">
                <!-- Fast Sellers -->
                <section class="analytics-section">
                    <h2>üöÄ Hƒ±zlƒ± Satanlar <span id="fastSellersCount" class="badge">0</span></h2>
                    <div class="analytics-table-container">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>√úr√ºn</th>
                                    <th>Satƒ±≈ü</th>
                                    <th>G√ºnl√ºk</th>
                                    <th>Stok</th>
                                </tr>
                            </thead>
                            <tbody id="fastSellersBody">
                                <tr><td colspan="4" class="loading">Y√ºkleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- New Arrivals -->
                <section class="analytics-section">
                    <h2>üì• Yeni Giri≈üler <span id="newArrivalsCount" class="badge">0</span></h2>
                    <div class="analytics-table-container">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>√úr√ºn</th>
                                    <th>Giri≈ü</th>
                                    <th>Depo</th>
                                    <th>Stok</th>
                                </tr>
                            </thead>
                            <tbody id="newArrivalsBody">
                                <tr><td colspan="4" class="loading">Y√ºkleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Slow Movers -->
                <section class="analytics-section">
                    <h2>üê¢ Yava≈ü Satanlar <span id="slowMoversCount" class="badge">0</span></h2>
                    <div class="analytics-table-container">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>√úr√ºn</th>
                                    <th>Stok</th>
                                    <th>G√ºn</th>
                                    <th>Deƒüer</th>
                                </tr>
                            </thead>
                            <tbody id="slowMoversBody">
                                <tr><td colspan="4" class="loading">Y√ºkleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Dead Stock -->
                <section class="analytics-section">
                    <h2>üíÄ √ñl√º Stok (30+ g√ºn) <span id="deadStockCount" class="badge">0</span></h2>
                    <div class="analytics-table-container">
                        <table class="analytics-table">
                            <thead>
                                <tr>
                                    <th>√úr√ºn</th>
                                    <th>Stok</th>
                                    <th>G√ºn</th>
                                    <th>Deƒüer</th>
                                </tr>
                            </thead>
                            <tbody id="deadStockBody">
                                <tr><td colspan="4" class="loading">Y√ºkleniyor...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- Category Performance -->
            <section class="section">
                <h2>üìä Kategori Performansƒ±</h2>
                <div class="table-container">
                    <table id="categoryTable">
                        <thead>
                            <tr>
                                <th>Kategori</th>
                                <th>√úr√ºn</th>
                                <th>Satƒ±≈ü</th>
                                <th>Giri≈ü</th>
                                <th>Toplam Deƒüer</th>
                            </tr>
                        </thead>
                        <tbody id="categoryBody">
                            <tr><td colspan="5" class="loading">Y√ºkleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

        </div><!-- END ANALYTICS TAB -->

    </div>

    <script>
        const API_URL = 'api/get-sales.php';
        const SNAPSHOT_URL = 'api/take-snapshot.php';
        const ANALYTICS_URL = 'api/get-analytics.php';

        let allSales = [];
        let allCategories = [];
        let availableSnapshots = [];
        let currentWarehouse = 'all';
        let currentCategory = 'all';
        let currentSort = 'default';
        let analyticsLoaded = false;

        // Tarih varsayƒ±lanlarƒ±
        function setDefaultDates() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            document.getElementById('date2').value = formatDate(today);
            document.getElementById('date1').value = formatDate(yesterday);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Verileri y√ºkle
        async function loadData() {
            const loadBtn = document.getElementById('loadBtn');
            loadBtn.disabled = true;
            loadBtn.textContent = 'Y√ºkleniyor...';

            const date1 = document.getElementById('date1').value;
            const date2 = document.getElementById('date2').value;

            try {
                const response = await fetch(`${API_URL}?date1=${date1}&date2=${date2}`);
                const data = await response.json();

                console.log('API Response:', data);

                if (!data.success) {
                    showNoData(data.error, data.availableSnapshots);
                    return;
                }

                // Snapshot bilgilerini g√∂ster
                availableSnapshots = data.availableSnapshots || [];
                showSnapshotInfo(data.period, availableSnapshots);

                // √ñzet kartlarƒ±nƒ± g√ºncelle
                document.getElementById('totalSales').textContent = data.summary.totalSales;
                document.getElementById('totalQty').textContent = data.summary.totalQty;
                document.getElementById('totalValue').textContent = '‚Ç¨' + formatNumber(data.summary.totalValueEUR);
                document.getElementById('bikeCount').textContent = data.summary.bikeCount;

                // Depo √∂zeti
                document.getElementById('cadde-sold').textContent = data.summary.byWarehouse.CADDEBOSTAN;
                document.getElementById('alsancak-sold').textContent = data.summary.byWarehouse.ALSANCAK;
                document.getElementById('bahcekoy-sold').textContent = data.summary.byWarehouse.BAHCEKOY;

                document.getElementById('lastUpdate').textContent = 'Y√ºklendi: ' + new Date().toLocaleTimeString('tr-TR');

                // Satƒ±≈ülarƒ± sakla
                allSales = data.sales;
                allCategories = data.categories || [];

                // Filtreleri sƒ±fƒ±rla
                currentWarehouse = 'all';
                currentCategory = 'all';
                currentSort = 'default';

                // Kategori butonlarƒ±nƒ± olu≈ütur
                renderCategoryButtons();

                // Tabloyu render et
                applyFilters();

                // Aktif butonlarƒ± sƒ±fƒ±rla
                resetActiveButtons();

            } catch (error) {
                console.error('Hata:', error);
                showNoData('Veri y√ºklenirken hata olu≈ütu: ' + error.message, []);
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'Y√ºkle';
            }
        }

        // Snapshot info g√∂ster
        function showSnapshotInfo(period, snapshots) {
            const infoDiv = document.getElementById('snapshotInfo');
            infoDiv.style.display = 'flex';

            document.getElementById('periodText').innerHTML =
                `üìÖ Kar≈üƒ±la≈ütƒ±rma: <strong>${period.from}</strong> ‚Üí <strong>${period.to}</strong> (${period.days} g√ºn)`;

            const listDiv = document.getElementById('snapshotList');
            listDiv.innerHTML = snapshots.slice(0, 7).map(s => {
                const isActive = s === period.from || s === period.to;
                return `<span class="snapshot-chip ${isActive ? 'active' : ''}" onclick="selectSnapshot('${s}')">${s}</span>`;
            }).join('');
        }

        function selectSnapshot(date) {
            document.getElementById('date1').value = date;
            loadData();
        }

        // Veri yok g√∂ster
        function showNoData(message, snapshots) {
            document.getElementById('snapshotInfo').style.display = 'none';
            document.getElementById('salesBody').innerHTML = `
                <tr>
                    <td colspan="7" class="no-data">
                        <div class="icon">üì≠</div>
                        <h3>${message}</h3>
                        <p>Mevcut snapshot'lar: ${snapshots.length > 0 ? snapshots.join(', ') : 'Hen√ºz yok'}</p>
                        <p style="margin-top: 10px;">Snapshot almak i√ßin "üì∏ Yeni Snapshot Al" butonuna tƒ±klayƒ±n.</p>
                    </td>
                </tr>
            `;
        }

        // Sayƒ± formatla
        function formatNumber(num) {
            return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
        }

        // Tabloyu render et
        function renderTable(sales) {
            const tbody = document.getElementById('salesBody');

            if (sales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-data">
                            <div class="icon">‚ú®</div>
                            <h3>Bu kriterlere uygun satƒ±≈ü bulunamadƒ±</h3>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sales.map(item => {
                const outClass = item.warehouseOut ? item.warehouseOut.toLowerCase().replace('√ß', 'c').replace('√∂', 'o') : '';
                const inClass = item.warehouseIn ? item.warehouseIn.toLowerCase().replace('√ß', 'c').replace('√∂', 'o') : '';
                const categoryClass = item.isBike ? 'bike' : 'other';
                const priceDisplay = item.currency === 'EUR' ? `‚Ç¨${formatNumber(item.price)}` : `${formatNumber(item.price)} ${item.currency}`;
                const totalDisplay = item.currency === 'EUR' ? `‚Ç¨${formatNumber(item.totalValue)}` : `${formatNumber(item.totalValue)} ${item.currency}`;

                // Depo isimlerini kƒ±salt
                const shortName = (name) => {
                    const map = {
                        'CADDEBOSTAN': 'CADDE',
                        'ALSANCAK': 'ALS',
                        'BAHCEKOY': 'BAH'
                    };
                    return map[name] || name.substring(0, 5);
                };

                // √áƒ±kan depo g√∂sterimi (miktar ile)
                let outDisplay = '-';
                if (item.outWarehouses && item.outWarehouses.length > 0) {
                    outDisplay = item.outWarehouses.map(w => {
                        const wClass = w.name.toLowerCase().replace('√ß', 'c').replace('√∂', 'o');
                        return `<span class="warehouse-badge out ${wClass}" title="${w.name}">${shortName(w.name)} <strong>-${w.qty}</strong></span>`;
                    }).join(' ');
                }

                // Giren depo g√∂sterimi (miktar ile)
                let inDisplay = '<span class="no-transfer">-</span>';
                if (item.inWarehouses && item.inWarehouses.length > 0) {
                    inDisplay = item.inWarehouses.map(w => {
                        const wClass = w.name.toLowerCase().replace('√ß', 'c').replace('√∂', 'o');
                        return `<span class="warehouse-badge in ${wClass}" title="${w.name}">${shortName(w.name)} <strong>+${w.qty}</strong></span>`;
                    }).join(' ');
                }

                return `
                    <tr>
                        <td><span class="product-code">${item.productCode || '-'}</span></td>
                        <td><span class="product-name" title="${item.productName}">${item.productName}</span></td>
                        <td><span class="category-badge ${categoryClass}">${item.category || 'Kategorisiz'}</span></td>
                        <td>${outDisplay}</td>
                        <td>${inDisplay}</td>
                        <td>
                            <span class="sold-qty">${item.soldQty}</span>
                            <div class="sold-from">${item.warehouseOut || item.warehouse}</div>
                        </td>
                        <td>
                            <div class="stock-change">
                                <span class="stock-before">${item.stockBefore}</span>
                                <span class="arrow">‚Üí</span>
                                <span class="stock-after">${item.stockAfter}</span>
                            </div>
                        </td>
                        <td class="price-cell">
                            <div class="unit-price">${priceDisplay}</div>
                            <div class="total-value">${totalDisplay}</div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Kategori butonlarƒ±nƒ± render et
        function renderCategoryButtons() {
            // √ñnce depo filtresini uygula
            let filtered = allSales;
            if (currentWarehouse !== 'all') {
                filtered = filtered.filter(s => s.warehouse === currentWarehouse);
            }

            // Kategorileri hesapla
            const categoryCounts = {};
            filtered.forEach(s => {
                const cat = s.category || 'Kategorisiz';
                if (!categoryCounts[cat]) {
                    categoryCounts[cat] = { count: 0, isBike: s.isBike };
                }
                categoryCounts[cat].count++;
            });

            // Sƒ±rala (bisikletler √∂nce)
            const sortedCategories = Object.entries(categoryCounts)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => {
                    if (a.isBike !== b.isBike) return b.isBike - a.isBike;
                    return b.count - a.count;
                });

            const container = document.getElementById('categoryButtons');
            container.innerHTML = sortedCategories.map(cat => {
                const bikeClass = cat.isBike ? 'bike-category' : '';
                return `<button class="category-btn ${bikeClass}" data-category="${cat.name}">${cat.name} (${cat.count})</button>`;
            }).join('');

            // Event listeners
            container.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentCategory = btn.dataset.category;
                    applyFilters();
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // T√ºm√º butonunu g√ºncelle
            const allBtn = document.querySelector('.category-btn[data-category="all"]');
            if (allBtn) {
                allBtn.textContent = `T√ºm√º (${filtered.length})`;
            }
        }

        // Filtreleri uygula
        function applyFilters() {
            let filtered = allSales;

            // Depo filtresi
            if (currentWarehouse !== 'all') {
                filtered = filtered.filter(s => s.warehouse === currentWarehouse);
            }

            // Kategori filtresi
            if (currentCategory !== 'all') {
                filtered = filtered.filter(s => (s.category || 'Kategorisiz') === currentCategory);
            }

            // Sƒ±ralama (sadece EUR)
            const getEurPrice = (item) => item.currency === 'EUR' ? (item.price || 0) : 0;
            const getEurTotal = (item) => item.currency === 'EUR' ? (item.totalValue || 0) : 0;

            switch(currentSort) {
                case 'price-desc':
                    filtered.sort((a, b) => getEurPrice(b) - getEurPrice(a));
                    break;
                case 'price-asc':
                    filtered.sort((a, b) => getEurPrice(a) - getEurPrice(b));
                    break;
                case 'qty-desc':
                    filtered.sort((a, b) => b.soldQty - a.soldQty);
                    break;
                case 'total-desc':
                    filtered.sort((a, b) => getEurTotal(b) - getEurTotal(a));
                    break;
                // 'default' - API'den gelen sƒ±ralama
            }

            renderTable(filtered);
            document.getElementById('salesCount').textContent = filtered.length;
        }

        // Aktif butonlarƒ± sƒ±fƒ±rla
        function resetActiveButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.warehouse === 'all');
            });
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === 'all');
            });
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.sort === 'default');
            });
        }

        // Yeni snapshot al
        async function takeSnapshot(silent = false) {
            const btn = document.getElementById('snapshotBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Alƒ±nƒ±yor...';

            try {
                const response = await fetch(SNAPSHOT_URL);
                const data = await response.json();

                if (data.success) {
                    if (!silent) {
                        alert(`‚úÖ Snapshot alƒ±ndƒ±!\n\nTarih: ${data.date}\n√úr√ºn sayƒ±sƒ±: ${data.totalProducts}\nS√ºre: ${data.executionTime}`);
                    }
                    // Tarihi bug√ºne ayarla ve y√ºkle
                    document.getElementById('date2').value = data.date;
                    return true;
                } else {
                    // Zaten alƒ±nmƒ±≈ü - bu sessiz modda sorun deƒüil
                    if (!silent) {
                        alert('‚ÑπÔ∏è ' + data.message);
                    }
                    return false;
                }
            } catch (error) {
                if (!silent) {
                    alert('‚ùå Hata: ' + error.message);
                }
                return false;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì∏ Yeni Snapshot Al';
            }
        }

        // Bug√ºn√ºn snapshot'ƒ± var mƒ± kontrol et
        async function checkAndTakeSnapshot() {
            const today = formatDate(new Date());

            // √ñnce mevcut snapshot'larƒ± kontrol et
            try {
                const response = await fetch(`${API_URL}?date1=${today}&date2=${today}`);
                const data = await response.json();

                // Bug√ºn√ºn snapshot'ƒ± yoksa otomatik al
                if (!data.success || !data.availableSnapshots || !data.availableSnapshots.includes(today)) {
                    console.log('Bug√ºn i√ßin snapshot yok, otomatik alƒ±nƒ±yor...');
                    document.getElementById('lastUpdate').textContent = 'üì∏ Bug√ºnk√º snapshot alƒ±nƒ±yor...';
                    const taken = await takeSnapshot(true);
                    if (taken) {
                        document.getElementById('lastUpdate').textContent = '‚úÖ Bug√ºnk√º snapshot alƒ±ndƒ±';
                    }
                } else {
                    console.log('Bug√ºn√ºn snapshot\'ƒ± zaten mevcut:', today);
                }
            } catch (error) {
                console.error('Snapshot kontrol hatasƒ±:', error);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            setDefaultDates();
            // √ñnce bug√ºn√ºn snapshot'ƒ±nƒ± kontrol et/al, sonra verileri y√ºkle
            await checkAndTakeSnapshot();
            loadData();
        });

        document.getElementById('loadBtn').addEventListener('click', loadData);
        document.getElementById('snapshotBtn').addEventListener('click', () => forceSnapshot());

        // Manuel snapshot (force)
        async function forceSnapshot() {
            const btn = document.getElementById('snapshotBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Alƒ±nƒ±yor...';

            try {
                const response = await fetch(SNAPSHOT_URL + '?force=1');
                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ Snapshot alƒ±ndƒ±!\n\nTarih: ${data.date}\n√úr√ºn sayƒ±sƒ±: ${data.totalProducts}\nS√ºre: ${data.executionTime}`);
                    document.getElementById('date2').value = data.date;
                    loadData();
                } else {
                    alert('‚ùå ' + (data.message || data.error));
                }
            } catch (error) {
                alert('‚ùå Hata: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì∏ Yeni Snapshot Al';
            }
        }

        // Depo filtreleri
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentWarehouse = btn.dataset.warehouse;
                currentCategory = 'all'; // Depo deƒüi≈üince kategori sƒ±fƒ±rla
                renderCategoryButtons();
                applyFilters();

                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.category-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.category === 'all');
                });
            });
        });

        // T√ºm√º kategori butonu
        document.querySelector('.category-btn[data-category="all"]').addEventListener('click', () => {
            currentCategory = 'all';
            applyFilters();
            document.querySelectorAll('.category-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.category === 'all');
            });
        });

        // Sƒ±ralama butonlarƒ±
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentSort = btn.dataset.sort;
                applyFilters();
                document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });

        // Depo kartlarƒ±na tƒ±klama
        document.querySelectorAll('.warehouse-card.clickable').forEach(card => {
            card.addEventListener('click', () => {
                const warehouse = card.dataset.warehouse;
                currentWarehouse = warehouse;
                currentCategory = 'all';

                // Depo filtre butonlarƒ±nƒ± g√ºncelle
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.warehouse === warehouse);
                });

                // Kategori butonlarƒ±nƒ± yenile ve sƒ±fƒ±rla
                renderCategoryButtons();
                document.querySelectorAll('.category-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.category === 'all');
                });

                // Depo kartlarƒ±nƒ±n se√ßili durumunu g√ºncelle
                document.querySelectorAll('.warehouse-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');

                applyFilters();

                // Tabloya scroll et
                document.querySelector('.section').scrollIntoView({ behavior: 'smooth' });
            });
        });

        // ============ TAB NAVIGATION ============
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;

                // Tab butonlarƒ±
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Tab i√ßerikleri
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById('tab-' + tab).classList.add('active');

                // Analytics ilk a√ßƒ±lƒ±≈üta y√ºkle
                if (tab === 'analytics' && !analyticsLoaded) {
                    loadAnalytics();
                }
            });
        });

        // ============ ANALYTICS ============
        document.getElementById('loadAnalyticsBtn').addEventListener('click', loadAnalytics);

        async function loadAnalytics() {
            const days = document.getElementById('analyticsDays').value;
            const btn = document.getElementById('loadAnalyticsBtn');
            btn.disabled = true;
            btn.textContent = 'Y√ºkleniyor...';

            try {
                // Paralel API √ßaƒürƒ±larƒ±
                const [summary, fastSellers, newArrivals, slowMovers, deadStock, categories] = await Promise.all([
                    fetch(`${ANALYTICS_URL}?type=summary&days=${days}`).then(r => r.json()),
                    fetch(`${ANALYTICS_URL}?type=fast-sellers&days=${days}&limit=15`).then(r => r.json()),
                    fetch(`${ANALYTICS_URL}?type=new-arrivals&days=${days}&limit=15`).then(r => r.json()),
                    fetch(`${ANALYTICS_URL}?type=slow-movers&days=${days}&limit=15`).then(r => r.json()),
                    fetch(`${ANALYTICS_URL}?type=dead-stock&days=30&limit=15`).then(r => r.json()),
                    fetch(`${ANALYTICS_URL}?type=category-performance&days=${days}`).then(r => r.json())
                ]);

                // Summary kartlarƒ±
                if (summary.success) {
                    document.getElementById('analyticsTotalProducts').textContent = summary.data.totalProducts;
                    document.getElementById('analyticsTotalSold').textContent = summary.data.totalSold;
                    document.getElementById('analyticsTotalArrived').textContent = summary.data.totalArrived;
                    document.getElementById('analyticsDeadStock').textContent = summary.data.deadStockCount;
                }

                // Hƒ±zlƒ± satanlar
                if (fastSellers.success) {
                    renderAnalyticsTable('fastSellersBody', fastSellers.data, 'fast');
                    document.getElementById('fastSellersCount').textContent = fastSellers.data.length;
                }

                // Yeni giri≈üler
                if (newArrivals.success) {
                    renderAnalyticsTable('newArrivalsBody', newArrivals.data, 'arrivals');
                    document.getElementById('newArrivalsCount').textContent = newArrivals.data.length;
                }

                // Yava≈ü satanlar
                if (slowMovers.success) {
                    renderAnalyticsTable('slowMoversBody', slowMovers.data, 'slow');
                    document.getElementById('slowMoversCount').textContent = slowMovers.data.length;
                }

                // √ñl√º stok
                if (deadStock.success) {
                    renderAnalyticsTable('deadStockBody', deadStock.data, 'dead');
                    document.getElementById('deadStockCount').textContent = deadStock.data.length;
                }

                // Kategori performansƒ±
                if (categories.success) {
                    renderCategoryPerformance(categories.data);
                }

                document.getElementById('analyticsLastUpdate').textContent =
                    `Son ${days} g√ºn - ${new Date().toLocaleTimeString('tr-TR')}`;

                analyticsLoaded = true;

            } catch (error) {
                console.error('Analytics hatasƒ±:', error);
                alert('Analitik y√ºklenirken hata: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analiz Et';
            }
        }

        function renderAnalyticsTable(bodyId, data, type) {
            const tbody = document.getElementById(bodyId);

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">Veri bulunamadƒ±</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                if (type === 'fast') {
                    return `
                        <tr>
                            <td>
                                <div class="product-code">${item.code || '-'}</div>
                                <div class="product-name-full">${item.title || '-'}</div>
                            </td>
                            <td><span class="sold-qty">${item.sold}</span></td>
                            <td><span class="daily-rate">${item.dailyRate}/g√ºn</span></td>
                            <td>${item.stockBefore} ‚Üí ${item.stockAfter}</td>
                        </tr>
                    `;
                } else if (type === 'arrivals') {
                    const warehouses = Object.entries(item.warehouses || {})
                        .map(([wh, qty]) => `<span class="warehouse-badge in ${wh.toLowerCase()}">${shortWarehouse(wh)} +${qty}</span>`)
                        .join(' ');
                    return `
                        <tr>
                            <td>
                                <div class="product-code">${item.code || '-'}</div>
                                <div class="product-name-full">${item.title || '-'}</div>
                            </td>
                            <td><span class="arrived-qty">+${item.arrived}</span></td>
                            <td>${warehouses || '-'}</td>
                            <td>${item.stockBefore} ‚Üí ${item.stockAfter}</td>
                        </tr>
                    `;
                } else {
                    // slow & dead
                    const valueDisplay = item.currency === 'EUR' ? `‚Ç¨${formatNumber(item.stockValue || 0)}` : '-';
                    return `
                        <tr>
                            <td>
                                <div class="product-code">${item.code || '-'}</div>
                                <div class="product-name-full">${item.title || '-'}</div>
                            </td>
                            <td>${item.currentStock}</td>
                            <td>${item.daysWithoutMovement} g√ºn</td>
                            <td>${valueDisplay}</td>
                        </tr>
                    `;
                }
            }).join('');
        }

        function renderCategoryPerformance(data) {
            const tbody = document.getElementById('categoryBody');

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">Veri bulunamadƒ±</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                const categoryClass = item.isBike ? 'bike' : 'other';
                const valueDisplay = `‚Ç¨${formatNumber(item.totalValue || 0)}`;
                return `
                    <tr>
                        <td><span class="category-badge ${categoryClass}">${item.name}</span></td>
                        <td>${item.productCount}</td>
                        <td><span class="sold-qty">${item.totalSold}</span></td>
                        <td><span class="arrived-qty">+${item.totalArrived}</span></td>
                        <td>${valueDisplay}</td>
                    </tr>
                `;
            }).join('');
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function shortWarehouse(name) {
            const map = { 'CADDEBOSTAN': 'CADDE', 'ALSANCAK': 'ALS', 'BAHCEKOY': 'BAH' };
            return map[name] || name.substring(0, 5);
        }
    </script>
</body>
</html>
